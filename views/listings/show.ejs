<% layout("/layouts/boilerplate") %>
  <link rel="stylesheet" href="/css/listings.css">

  <div class="container mt-5">
    <div class="row justify-content-center">
      <div class="col-lg-8 col-md-10">
        <h2 class="text-center fw-bold mb-4" style="font-size: 2rem; color: #2c3e50;">
          <%= listing.title %>
        </h2>

        <!-- Listing Image -->
        <div class="card shadow-lg border-0 rounded-4 mb-3">
          <img src="<%= listing.image.url %>" class="card-img-top rounded-top-4"
            style="height: 380px; object-fit: cover;" alt="Listing Image" />
        </div>

        <!-- Owner -->
        <p class="text-muted text-start ms-1">
          Owned by <b class="text-primary">
            <%= listing.owner ? listing.owner.username : "Unknown" %>
          </b>
        </p>

        <!-- Description + Info -->
        <div class="p-4 rounded-4 shadow-sm bg-white mb-4">

          <p class="fs-6 text-muted lh-lg">
            <%= listing.description %>
          </p>

          <ul class="list-unstyled fs-6 mt-3">
            <li class="price-box">
              <strong>Price:</strong>

              <span class="old-price" style="display:none;">
                ₹<%= listing.price.toLocaleString("en-IN") %>
              </span>

              <span class="new-price" data-price="<%= listing.price %>">
                ₹<%= listing.price.toLocaleString("en-IN") %>
              </span>

              <span class="offers-text" style="display:none;">(15% OFF)</span>
            </li>

            </li>
            <li><strong>Location:</strong>
              <%= listing.location %>
            </li>
            <li><strong>Country:</strong>
              <%= listing.country %>
            </li>
            <li><strong>Category:</strong>
              <%= listing.category %>
            </li>
          </ul>

          <!-- Owner Controls -->
          <% if(currUser && currUser._id.equals(listing.owner._id)) { %>
            <div class="mt-4">
              <a href="/listings/<%= listing._id %>/edit" class="btn btn-primary rounded-pill px-4 me-2">
                Edit
              </a>

              <form method="POST" action="/listings/<%= listing._id %>?_method=DELETE" class="d-inline">
                <button type="submit" class="btn btn-danger rounded-pill px-4">
                  Delete
                </button>
              </form>
            </div>
            <% } %>
        </div>

        <hr class="my-4">
        <!-- Review Section -->
        <h4 class="text-center fw-semibold mb-4">Leave a Review</h4>

        <form action="/listings/<%= listing.id %>/reviews" method="POST" class="p-4 bg-white rounded-4 shadow-sm mb-5">

          <label class="fw-semibold mb-1">Rating</label>
          <fieldset class="starability-slot mb-3">
            <input type="radio" id="no-rate" class="input-no-rate" name="review[rating]" value="0" checked />
            <input type="radio" id="rate1" name="review[rating]" value="1" /><label for="rate1">1</label>
            <input type="radio" id="rate2" name="review[rating]" value="2" /><label for="rate2">2</label>
            <input type="radio" id="rate3" name="review[rating]" value="3" /><label for="rate3">3</label>
            <input type="radio" id="rate4" name="review[rating]" value="4" /><label for="rate4">4</label>
            <input type="radio" id="rate5" name="review[rating]" value="5" /><label for="rate5">5</label>
          </fieldset>

          <label class="fw-semibold mb-1">Comment</label>
          <textarea name="review[comment]" class="form-control mb-3" rows="4" placeholder="Write your review here..."
            required></textarea>

          <button class="btn btn-dark w-100 rounded-pill py-2">Submit Review</button>
        </form>

        <!-- Show Reviews -->
        <% if (listing.reviews.length> 0) { %>
          <h4 class="fw-bold mb-3">All Reviews</h4>

          <div class="row">
            <% for (let review of listing.reviews) { %>
              <div class="col-md-6 mb-3">
                <div class="card shadow-sm rounded-4">
                  <div class="card-body">
                    <h5 class="card-title">@<%= review.author.username %>
                    </h5>
                    <p class="starability-result" data-rating="<%= review.rating %>"></p>
                    <p class="card-text text-muted">
                      <%= review.comment %>
                    </p>

                    <% if(currUser && currUser._id.equals(review.author._id)) {%>
                      <a href="/listings/<%= listing._id %>/reviews/<%= review._id %>/edit"
                        class="btn btn-outline-primary btn-sm rounded-pill px-4 me-2">
                        Edit
                      </a>
                      <form action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE" method="POST"
                        class="d-inline">
                        <button class="btn btn-danger btn-sm rounded-pill px-4">Delete</button>
                      </form>
                      <% } %>
                  </div>
                </div>
              </div>
              <% } %>
          </div>
          <% } %>
      </div>
    </div>

    <!-- Map Section -->
    <h3 class="mt-5 text-center fw-bold">Where you'll be</h3>

    <% if (listing.geometry && listing.geometry.coordinates) { %>
      <div class="d-flex justify-content-center mt-3 mb-5">
        <div id="map" data-lng="<%= listing.geometry.coordinates[0] %>"
          data-lat="<%= listing.geometry.coordinates[1] %>" data-token="<%= LOCATION_IQ_TOKEN %>"
          data-title="<%= listing.title %>" data-place="<%= listing.location %>, <%= listing.country %>"
          class="shadow-lg border rounded-4" style="
        height: 450px;
        width: 95%;
        max-width: 1200px;
        border-radius: 20px !important;
        overflow: hidden;
      ">
        </div>
      </div>
      <% } %>

  </div>
  <script src="/js/offerToggle.js"></script>
  <script src="/js/showMap.js"></script>